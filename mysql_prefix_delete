#!/bin/bash
# delete_guac_connections.sh
# Usage: ./delete_guac_connections.sh myprefix

set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 PREFIX"
  exit 1
fi

PREFIX="$1"

DBHOST="<replace_host>"
DBPORT="<replace_port>"
DBUSER="<replace_username>"
DBPASS="<replace_password>"
DBNAME="<replace_db>"

mysql -h "$DBHOST" -P "$DBPORT" -u "$DBUSER" -p"$DBPASS" "$DBNAME" <<EOF
START TRANSACTION;

-- Delete permissions tied to these connections
DELETE cp
FROM guacamole_connection_permission cp
JOIN guacamole_connection c ON cp.connection_id = c.connection_id
WHERE c.connection_name LIKE '${PREFIX}%';

-- Delete history for these connections
DELETE ch
FROM guacamole_connection_history ch
JOIN guacamole_connection c ON ch.connection_id = c.connection_id
WHERE c.connection_name LIKE '${PREFIX}%';

-- Delete parameters for these connections
DELETE p
FROM guacamole_connection_parameter p
JOIN guacamole_connection c ON p.connection_id = c.connection_id
WHERE c.connection_name LIKE '${PREFIX}%';

-- Finally, delete the connections themselves
DELETE FROM guacamole_connection
WHERE connection_name LIKE '${PREFIX}%';

COMMIT;
EOF
